input {
  beats {
    port => 5044
  }
  
  # Also accept direct TCP input for docker logs
  tcp {
    port => 5000
    codec => json
  }

  # GELF input for Docker logging driver
  gelf {
    port => 12201
    type => "docker"
  }
}

filter {
  # Extract container tag as serviceName
  if [tag] {
    mutate {
      add_field => { "serviceName" => "%{tag}" }
    }
  }

  # Parse JSON logs from message field
  if [message] =~ /^\{/ {
    json {
      source => "message"
      target => "parsed"
      skip_on_invalid_json => true
    }
    
    # Extract key fields to top level for easier querying
    if [parsed][correlationId] {
      mutate {
        add_field => { "correlationId" => "%{[parsed][correlationId]}" }
      }
    }
    
    if [parsed][service] {
      mutate {
        replace => { "serviceName" => "%{[parsed][service]}" }
      }
    }
    
    if [parsed][level] {
      mutate {
        add_field => { "logLevel" => "%{[parsed][level]}" }
      }
    }
    
    # Extract method, url, statusCode for HTTP logs
    if [parsed][method] {
      mutate {
        add_field => { "httpMethod" => "%{[parsed][method]}" }
      }
    }
    
    if [parsed][url] {
      mutate {
        add_field => { "httpUrl" => "%{[parsed][url]}" }
      }
    }
    
    if [parsed][statusCode] {
      mutate {
        add_field => { "httpStatus" => "%{[parsed][statusCode]}" }
      }
    }
    
    if [parsed][duration] {
      mutate {
        add_field => { "duration" => "%{[parsed][duration]}" }
      }
    }
  }
  
  # Ensure logLevel exists with default value
  if ![logLevel] {
    mutate {
      add_field => { "logLevel" => "info" }
    }
  }
  
  # Normalize log levels to lowercase
  mutate {
    lowercase => [ "logLevel" ]
  }
  
  # Parse timestamp
  if [parsed][timestamp] {
    date {
      match => [ "[parsed][timestamp]", "ISO8601" ]
      target => "@timestamp"
    }
  }
  
  # Add metadata
  mutate {
    add_field => { "[@metadata][index_name]" => "quetzalship-logs-%{+YYYY.MM.dd}" }
  }
}

output {
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][index_name]}"
    
    # Create index template for better mapping
    template_name => "quetzalship-logs"
    template_overwrite => true
  }
  
  # Optional: stdout for debugging
  # stdout { 
  #   codec => rubydebug 
  # }
}

