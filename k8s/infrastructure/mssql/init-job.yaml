# Database initialization job
apiVersion: batch/v1
kind: Job
metadata:
  name: mssql-init
  namespace: quetzalship
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      containers:
        - name: mssql-init
          image: mcr.microsoft.com/mssql-tools18
          env:
            - name: SA_PASSWORD
              valueFrom:
                secretKeyRef:
                  name: mssql-secret
                  key: SA_PASSWORD
          command:
            - /bin/bash
            - -c
            - |
              echo "Waiting for MSSQL to be ready..."
              sleep 30
              
              # Create database
              /opt/mssql-tools18/bin/sqlcmd -S mssql-service -U sa -P "$SA_PASSWORD" -C -Q "
              IF NOT EXISTS (SELECT * FROM sys.databases WHERE name = 'quetzalship')
              BEGIN
                  CREATE DATABASE quetzalship;
                  PRINT 'Database quetzalship created';
              END
              ELSE
              BEGIN
                  PRINT 'Database quetzalship already exists';
              END
              "
              
              # Create orders table
              /opt/mssql-tools18/bin/sqlcmd -S mssql-service -U sa -P "$SA_PASSWORD" -d quetzalship -C -Q "
              IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='orders' AND xtype='U')
              BEGIN
                  CREATE TABLE orders (
                      id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
                      client_name NVARCHAR(255) NOT NULL,
                      origin_zone NVARCHAR(50) NOT NULL,
                      destination_zone NVARCHAR(50) NOT NULL,
                      service_type NVARCHAR(50) NOT NULL,
                      status NVARCHAR(50) NOT NULL DEFAULT 'ACTIVE',
                      insurance_enabled BIT NOT NULL DEFAULT 0,
                      subtotal DECIMAL(10,2) NOT NULL,
                      discount_amount DECIMAL(10,2) DEFAULT 0,
                      surcharges DECIMAL(10,2) DEFAULT 0,
                      insurance_amount DECIMAL(10,2) DEFAULT 0,
                      total DECIMAL(10,2) NOT NULL,
                      currency NVARCHAR(10) DEFAULT 'GTQ',
                      idempotency_key NVARCHAR(255),
                      created_at DATETIME2 DEFAULT GETUTCDATE(),
                      updated_at DATETIME2 DEFAULT GETUTCDATE()
                  );
                  
                  CREATE INDEX idx_orders_idempotency ON orders(idempotency_key);
                  CREATE INDEX idx_orders_status ON orders(status);
                  CREATE INDEX idx_orders_created ON orders(created_at);
                  
                  PRINT 'Table orders created';
              END
              ELSE
              BEGIN
                  PRINT 'Table orders already exists';
              END
              "
              
              # Create packages table
              /opt/mssql-tools18/bin/sqlcmd -S mssql-service -U sa -P "$SA_PASSWORD" -d quetzalship -C -Q "
              IF NOT EXISTS (SELECT * FROM sysobjects WHERE name='packages' AND xtype='U')
              BEGIN
                  CREATE TABLE packages (
                      id UNIQUEIDENTIFIER PRIMARY KEY DEFAULT NEWID(),
                      order_id UNIQUEIDENTIFIER NOT NULL,
                      weight_kg DECIMAL(10,2) NOT NULL,
                      height_cm DECIMAL(10,2) NOT NULL,
                      width_cm DECIMAL(10,2) NOT NULL,
                      length_cm DECIMAL(10,2) NOT NULL,
                      fragile BIT NOT NULL DEFAULT 0,
                      declared_value_q DECIMAL(10,2) DEFAULT 0,
                      FOREIGN KEY (order_id) REFERENCES orders(id) ON DELETE CASCADE
                  );
                  
                  CREATE INDEX idx_packages_order ON packages(order_id);
                  
                  PRINT 'Table packages created';
              END
              ELSE
              BEGIN
                  PRINT 'Table packages already exists';
              END
              "
              
              echo "Database initialization complete!"
      restartPolicy: OnFailure
  backoffLimit: 3
